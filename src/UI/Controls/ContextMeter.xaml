<UserControl x:Class="PairAdmin.UI.Controls.ContextMeter"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="60"
             d:DesignWidth="300">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/UI/Styles/ChatStyles.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Colors -->
            <SolidColorBrush x:Key="MeterSafeColor" Color="#2ECC71" />
            <SolidColorBrush x:Key="MeterWarningColor" Color="#F1C40F" />
            <SolidColorBrush x:Key="MeterCriticalColor" Color="#E74C3C" />
            <SolidColorBrush x:Key="MeterOverlimitColor" Color="#C0392B" />

            <!-- Converter for percentage to color -->
            <Style x:Key="ColorConverter" TargetType="SolidColorBrush">
                <Style.Triggers>
                    <DataTrigger Binding="{Binding Percentage, Converter={StaticResource PercentageToDoubleConverter}}" Value="0.0">
                        <Setter Property="Color" Value="Green" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Percentage, Converter={StaticResource PercentageToDoubleConverter}}" Value="0.7">
                        <Setter Property="Color" Value="Yellow" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Percentage, Converter={StaticResource PercentageToDoubleConverter}}" Value="0.9">
                        <Setter Property="Color" Value="Red" />
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Border Background="#F5F5F5"
            BorderBrush="#E0E0E0"
            BorderThickness="0,0,0,1"
            Padding="8,4">
        <StackPanel>
            <!-- Header -->
            <Grid Margin="0,0,0,4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="Context Usage"
                           FontSize="12"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource TextPrimary}"
                           VerticalAlignment="Center" />

                <TextBlock Grid.Column="1"
                           Text="{Binding FormattedMaxTokens}"
                           FontSize="11"
                           Foreground="{StaticResource TextSecondary}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Right" />
            </Grid>

            <!-- Progress Bar Container -->
            <Border Background="White"
                    BorderBrush="{StaticResource BorderNormal}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="0">
                <Grid MinHeight="30">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Progress Bar Background -->
                    <Border Grid.Column="0"
                            Background="#ECF0F1"
                            CornerRadius="4,0,0,4">
                        <Grid MinHeight="28">
                            <!-- Progress Fill -->
                            <Border Background="{Binding FillColor}"
                                    CornerRadius="4,0,0,4"
                                    HorizontalAlignment="Left"
                                    MinHeight="28">
                                <Border.Width>
                                    <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                        <Binding Path="Percentage" />
                                        <Binding Path="ActualWidth" ElementName="ProgressContainer" />
                                    </MultiBinding>
                                </Border.Width>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Token Count Display -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding FormattedTokenCount}"
                               FontSize="12"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource TextPrimary}"
                               VerticalAlignment="Center"
                               Margin="4,0,0,0">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Status}" Value="Critical">
                                        <Setter Property="Foreground" Value="{StaticResource MeterCriticalColor}" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Status}" Value="OverLimit">
                                        <Setter Property="Foreground" Value="{StaticResource MeterOverlimitColor}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Border>

            <!-- Details Row -->
            <Grid Margin="0,4,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="{Binding FormattedPercentage, StringFormat='Usage: {0}'}"
                           FontSize="11"
                           Foreground="{StaticResource TextSecondary}"
                           HorizontalAlignment="Left" />

                <TextBlock Grid.Column="1"
                           Text="{Binding StatusText}"
                           FontSize="11"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Right">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Status}" Value="Safe">
                                    <Setter Property="Foreground" Value="{StaticResource MeterSafeColor}" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Status}" Value="Warning">
                                    <Setter Property="Foreground" Value="{StaticResource MeterWarningColor}" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Status}" Value="Critical">
                                    <Setter Property="Foreground" Value="{StaticResource MeterCriticalColor}" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Status}" Value="OverLimit">
                                    <Setter Property="Foreground" Value="{StaticResource MeterOverlimitColor}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
        </StackPanel>

        <!-- Tooltip -->
        <Border.ToolTip>
            <StackPanel>
                <TextBlock Text="Context Usage Details" FontWeight="SemiBold" Margin="0,0,0,8" />
                <TextBlock Text="{Binding CurrentTokens, StringFormat='Current Tokens: {0}'}" Margin="0,0,0,4" />
                <TextBlock Text="{Binding MaxTokens, StringFormat='Max Tokens: {0}'}" Margin="0,0,0,4" />
                <TextBlock Text="{Binding Percentage, StringFormat='Percentage: {0:P1}'}" Margin="0,0,0,4" />
                <TextBlock Text="{Binding AvailableTokens, StringFormat='Available: {0}'}" Margin="0,0,0,4" />
                <TextBlock Text="{Binding StatusText}" Margin="0,0,0,8" FontWeight="SemiBold" />
            </StackPanel>
        </Border.ToolTip>
    </Border>
</UserControl>
